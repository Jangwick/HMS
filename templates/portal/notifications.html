{% extends "base/subsystem_base.html" %}

{% block header_title %}Notifications{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">Notifications</h1>
            <p class="text-gray-500 font-medium">Keep track of your system alerts and activities.</p>
        </div>
        
        <div class="flex items-center space-x-3">
            <form action="{{ url_for('portal.mark_all_notifications_read') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="px-6 py-3 bg-white border border-gray-200 text-gray-700 font-bold rounded-2xl hover:bg-gray-50 transition-all shadow-sm flex items-center space-x-2">
                    <i class="bi bi-check2-all"></i>
                    <span>Mark All Read</span>
                </button>
            </form>

            <div class="relative inline-block text-left" id="clearDropdown">
                <button onclick="toggleClearMenu()" class="px-4 py-3 bg-white border border-gray-200 text-gray-400 font-bold rounded-2xl hover:bg-gray-50 transition-all shadow-sm flex items-center">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <div id="clearMenu" class="hidden absolute right-0 mt-2 w-56 rounded-2xl shadow-xl bg-white ring-1 ring-black ring-opacity-5 z-50 overflow-hidden border border-gray-100">
                    <div class="py-1">
                        <form action="{{ url_for('portal.clear_all_notifications') }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="only_read" value="true">
                            <button type="submit" class="flex items-center w-full px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 font-medium">
                                <i class="bi bi-eraser mr-3 text-gray-400"></i> Clear Read
                            </button>
                        </form>
                        <form action="{{ url_for('portal.clear_all_notifications') }}" method="POST" onsubmit="return confirm('Are you sure you want to clear ALL notifications?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="only_read" value="false">
                            <button type="submit" class="flex items-center w-full px-4 py-3 text-sm text-red-600 hover:bg-red-50 font-medium">
                                <i class="bi bi-trash3 mr-3 text-red-400"></i> Clear All
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
            {% if notifications %}
                <div class="divide-y divide-gray-50">
                    {% for n in notifications %}
                    <div class="p-6 hover:bg-gray-50/50 transition-colors {% if not n.is_read %}bg-{{ subsystem_color or 'blue' }}-50/30 border-l-4 border-{{ subsystem_color or 'blue' }}-500{% endif %}"
                         id="notif-{{ n.id }}">
                        <div class="flex items-start justify-between">
                            <div class="flex space-x-4">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center shrink-0 
                                    {% if n.type == 'danger' %}bg-red-50 text-red-600
                                    {% elif n.type == 'warning' %}bg-amber-50 text-amber-600
                                    {% elif n.type == 'success' %}bg-emerald-50 text-emerald-600
                                    {% else %}bg-blue-50 text-blue-600{% endif %}">
                                    <i class="bi {% if n.type == 'danger' %}bi-exclamation-octagon{% elif n.type == 'warning' %}bi-exclamation-triangle{% elif n.type == 'success' %}bi-check-circle{% else %}bi-info-circle{% endif %}"></i>
                                </div>
                                <div>
                                    <h3 class="text-base font-bold text-gray-900 mb-1">{{ n.title }}</h3>
                                    <p class="text-sm text-gray-600 leading-relaxed mb-3">{{ n.message }}</p>
                                    
                                    <div class="flex items-center space-x-4">
                                        <span class="text-[10px] font-black text-gray-400 ring-1 ring-gray-100 px-2 py-0.5 rounded uppercase tracking-widest">{{ n.sender_subsystem | upper }}</span>
                                        <span class="text-xs text-gray-400 flex items-center">
                                            <i class="bi bi-clock mr-1.5"></i>
                                            {{ n.created_at | datetime }}
                                        </span>
                                        {% if not n.is_read %}
                                        <button onclick="markAsReadSingle('{{ n.id }}')" class="text-xs text-{{ subsystem_color or 'blue' }}-600 font-black uppercase tracking-widest hover:underline">
                                            Mark as read
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                {% if n.target_url %}
                                <a href="{{ n.target_url }}" class="p-2 text-gray-400 hover:text-{{ subsystem_color or 'blue' }}-600 hover:bg-white rounded-xl transition-all border border-transparent hover:border-gray-100" title="View details">
                                    <i class="bi bi-arrow-right-short text-2xl"></i>
                                </a>
                                {% endif %}
                                <button onclick="deleteNotif('{{ n.id }}')" class="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all border border-transparent hover:border-red-100" title="Delete notification">
                                    <i class="bi bi-trash3 text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="p-20 text-center">
                    <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="bi bi-bell-slash text-4xl text-gray-200"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-1">Stay Tuned!</h3>
                    <p class="text-gray-500">You don't have any notifications right now.</p>
                </div>
            {% endif %}
    </div>
    
    <div class="mt-8 text-center">
        <a href="{{ url_for(blueprint_name + '.dashboard') if blueprint_name else url_for('portal.index') }}" class="text-sm font-bold text-gray-400 hover:text-gray-900 transition-colors">
            <i class="bi bi-arrow-left mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

<script>
function toggleClearMenu() {
    const menu = document.getElementById('clearMenu');
    menu.classList.toggle('hidden');
}

// Close menu when clicking outside
window.addEventListener('click', function(e) {
    if (!document.getElementById('clearDropdown').contains(e.target)) {
        document.getElementById('clearMenu').classList.add('hidden');
    }
});

async function markAsReadSingle(id) {
    try {
        const response = await fetch(`/notifications/read/${id}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        if (response.ok) {
            const el = document.getElementById(`notif-${id}`);
            el.classList.remove('bg-{{ subsystem_color or "blue" }}-50/30', 'border-l-4', 'border-{{ subsystem_color or "blue" }}-500');
            // Remove the mark as read button
            const btn = el.querySelector('button[onclick^="markAsReadSingle"]');
            if (btn) btn.remove();
        }
    } catch (err) {
        console.error('Error marking notification as read:', err);
    }
}

async function deleteNotif(id) {
    if (!confirm('Are you sure you want to delete this notification?')) return;
    
    try {
        const response = await fetch(`/notifications/delete/${id}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        if (response.ok) {
            const el = document.getElementById(`notif-${id}`);
            el.style.opacity = '0';
            el.style.transform = 'translateX(20px)';
            setTimeout(() => {
                el.remove();
                if (document.querySelectorAll('[id^="notif-"]').length === 0) {
                    location.reload(); // Show the empty state
                }
            }, 300);
        }
    } catch (err) {
        console.error('Error deleting notification:', err);
    }
}
</script>
{% endblock %}

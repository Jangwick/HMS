{% extends "base/base.html" %}

{% block title %}User Directory - {{ subsystem_name }}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 overflow-hidden font-sans">
    <!-- Sidebar -->
    <aside class="w-72 bg-white shadow-2xl hidden md:flex flex-col z-20 border-r border-gray-100">
        <div class="h-20 flex items-center px-8 border-b border-gray-100">
            <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#0EA5E9] to-gray-800 flex items-center justify-center shadow-lg mr-4 text-white">
                <i class="bi bi-clock-history text-lg"></i>
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-gray-900 tracking-tight">HR3</h1>
                <p class="text-xs font-medium text-gray-400 uppercase tracking-wider">System</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Main Menu</p>

            <a href="{{ url_for('hr3.dashboard') }}"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i
                    class="bi bi-speedometer2 text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Dashboard
            </a>

            <a href="#"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i class="bi bi-people text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Personnel
            </a>

            <a href="#"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i
                    class="bi bi-file-earmark-text text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Reports
            </a>

            {% if current_user.role in ['Admin', 'Administrator'] and current_user.subsystem == 'hr3' %}
            <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">Administration</p>

            <a href="{{ url_for('hr3.pending_approvals') }}"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i
                    class="bi bi-person-check text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Pending Approvals
            </a>

            <a href="{{ url_for('hr3.user_list') }}"
                class="flex items-center px-4 py-3 bg-[#0EA5E9]/10 text-[#0EA5E9] rounded-xl transition-all duration-200 font-bold group shadow-sm">
                <i class="bi bi-people-fill text-xl mr-3 group-hover:scale-110 transition-transform"></i>
                User Directory
            </a>
            {% endif %}

            <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">System</p>

            <a href="#"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i class="bi bi-gear text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Settings
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50/50">
            <div class="flex items-center mb-4 p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-white font-bold shadow-md">
                    {{ current_user.username[0] | upper }}
                </div>
                <div class="ml-3 overflow-hidden">
                    <p class="text-sm font-bold text-gray-900 truncate">{{ current_user.username }}</p>
                    <p class="text-xs text-gray-500 truncate">{{ current_user.role }}</p>
                </div>
            </div>
            <a href="{{ url_for('hr3.logout') }}"
                class="flex items-center justify-center w-full px-4 py-2.5 text-sm font-bold text-red-600 bg-red-50 rounded-xl hover:bg-red-100 transition-all duration-200 hover:shadow-md">
                <i class="bi bi-box-arrow-right mr-2"></i> Sign Out
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Top Header -->
        <header
            class="bg-white/80 backdrop-blur-md shadow-sm h-20 flex items-center justify-between px-8 sticky top-0 z-10 border-b border-gray-100">
            <div class="flex items-center">
                <h2 class="text-2xl font-bold text-gray-800 tracking-tight">User Directory</h2>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="openAddUserModal()"
                    class="flex items-center gap-2 px-5 py-2.5 bg-[#0EA5E9] hover:bg-[#0284C7] text-white rounded-xl font-bold text-sm transition-all shadow-lg shadow-[#0EA5E9]/20 transform hover:-translate-y-0.5">
                    <i class="bi bi-person-plus-fill text-lg"></i>
                    Add New User
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="mb-6 space-y-3">
                {% for category, message in messages %}
                <div class="p-4 rounded-xl flex items-center gap-3
                    {% if category == 'success' %}bg-emerald-50 border border-emerald-200 text-emerald-700
                    {% elif category == 'danger' %}bg-red-50 border border-red-200 text-red-700
                    {% elif category == 'warning' %}bg-amber-50 border border-amber-200 text-amber-700
                    {% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %}">
                    {% if category == 'success' %}
                    <i class="bi bi-check-circle-fill"></i>
                    {% elif category == 'danger' %}
                    <i class="bi bi-x-circle-fill"></i>
                    {% elif category == 'warning' %}
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    {% else %}
                    <i class="bi bi-info-circle-fill"></i>
                    {% endif %}
                    <span class="font-medium">{{ message }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Filter Tabs -->
            <div class="flex gap-2 mb-6 flex-wrap">
                <button
                    class="filter-btn active px-4 py-2 rounded-xl text-sm font-medium transition-all bg-[#0EA5E9] text-white shadow-md"
                    data-filter="all">
                    All Users ({{ users|length }})
                </button>
                <button
                    class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"
                    data-filter="Active">
                    Active ({{ users|selectattr('status', 'equalto', 'Active')|list|length }})
                </button>
                <button
                    class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"
                    data-filter="Pending">
                    Pending ({{ users|selectattr('status', 'equalto', 'Pending')|list|length }})
                </button>
                <button
                    class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"
                    data-filter="Rejected">
                    Rejected ({{ users|selectattr('status', 'equalto', 'Rejected')|list|length }})
                </button>
            </div>

            <!-- Users Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-100">
                                <th class="px-6 py-4 text-sm font-bold text-gray-600">User</th>
                                <th class="px-6 py-4 text-sm font-bold text-gray-600">Department</th>
                                <th class="px-6 py-4 text-sm font-bold text-gray-600">Role</th>
                                <th class="px-6 py-4 text-sm font-bold text-gray-600">Status</th>
                                <th class="px-6 py-4 text-sm font-bold text-gray-600">Password</th>
                                <th class="px-6 py-4 text-sm font-bold text-gray-600 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for user in users %}
                            <tr class="user-row hover:bg-gray-50 transition-colors" data-status="{{ user.status }}">
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 rounded-full bg-gradient-to-br from-[#0EA5E9] to-gray-600 flex items-center justify-center text-white font-bold shadow-md">
                                            {{ user.username[0]|upper }}
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-900">{{ user.username }}</div>
                                            <div class="text-xs text-gray-500">{{ user.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 rounded-md bg-gray-100 text-xs font-medium text-gray-600">
                                        {{ user.subsystem|upper }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="text-sm text-gray-700">{{ user.role }}</span>
                                </td>
                                <td class="px-6 py-4">
                                    {% if user.status == 'Active' %}
                                    <span
                                        class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-600 text-[10px] font-bold uppercase tracking-wider border border-emerald-100">Active</span>
                                    {% elif user.status == 'Pending' %}
                                    <span
                                        class="px-3 py-1 rounded-full bg-amber-50 text-amber-600 text-[10px] font-bold uppercase tracking-wider border border-amber-100">Pending</span>
                                    {% else %}
                                    <span
                                        class="px-3 py-1 rounded-full bg-red-50 text-red-600 text-[10px] font-bold uppercase tracking-wider border border-red-100">{{
                                        user.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">
                                    {% if user.is_password_expired() %}
                                    <span class="flex items-center gap-1 text-red-500 text-xs font-medium">
                                        <i class="bi bi-exclamation-circle-fill"></i>
                                        Expired
                                    </span>
                                    {% else %}
                                    <span class="text-gray-500 text-xs">{{ user.days_until_password_expiry() }}d
                                        left</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="relative inline-block text-left">
                                        <button onclick="toggleDropdown(this)"
                                            class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <div
                                            class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-xl shadow-xl z-50 overflow-hidden">
                                            {% if user.status == 'Pending' %}
                                            <a href="{{ url_for('hr3.process_approval', user_id=user.id, action='approve') }}"
                                                class="flex items-center gap-2 px-4 py-3 text-sm text-emerald-600 hover:bg-emerald-50 transition-colors">
                                                <i class="bi bi-check-lg"></i>
                                                Approve User
                                            </a>
                                            <a href="{{ url_for('hr3.process_approval', user_id=user.id, action='deny') }}"
                                                class="flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                                <i class="bi bi-x-lg"></i>
                                                Deny User
                                            </a>
                                            {% elif user.status == 'Active' %}
                                            <a href="{{ url_for('hr3.reset_user_password', user_id=user.id) }}"
                                                class="flex items-center gap-2 px-4 py-3 text-sm text-gray-600 hover:bg-gray-50 transition-colors"
                                                onclick="return confirm('Are you sure you want to reset this user\'s password to default?')">
                                                <i class="bi bi-shield-lock"></i>
                                                Reset Password
                                            </a>
                                            <a href="{{ url_for('hr3.toggle_user_status', user_id=user.id) }}"
                                                class="flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors"
                                                onclick="return confirm('Are you sure you want to deactivate this user?')">
                                                <i class="bi bi-person-x"></i>
                                                Deactivate User
                                            </a>
                                            {% else %}
                                            <a href="{{ url_for('hr3.toggle_user_status', user_id=user.id) }}"
                                                class="flex items-center gap-2 px-4 py-3 text-sm text-emerald-600 hover:bg-emerald-50 transition-colors">
                                                <i class="bi bi-person-check"></i>
                                                Activate User
                                            </a>
                                            {% endif %}

                                            <!-- Global Actions (All states) -->
                                            <hr class="border-gray-100">
                                            <button data-id="{{ user.id }}" data-username="{{ user.username }}"
                                                data-email="{{ user.email }}"
                                                data-subsystem="{{ user.subsystem|upper }}"
                                                data-department="{{ user.department }}" data-role="{{ user.role }}"
                                                data-status="{{ user.status }}"
                                                data-joined="{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}"
                                                onclick="handleViewDetails(this)"
                                                class="w-full flex items-center gap-2 px-4 py-3 text-sm text-gray-600 hover:bg-gray-50 transition-colors">
                                                <i class="bi bi-person-badge"></i>
                                                View Details
                                            </button>
                                            <button data-id="{{ user.id }}" data-username="{{ user.username }}"
                                                data-email="{{ user.email }}" data-subsystem="{{ user.subsystem }}"
                                                data-role="{{ user.role }}" data-status="{{ user.status }}"
                                                onclick="handleEditUser(this)"
                                                class="w-full flex items-center gap-2 px-4 py-3 text-sm text-amber-600 hover:bg-amber-50 transition-colors">
                                                <i class="bi bi-pencil-square"></i>
                                                Edit Details
                                            </button>
                                            <button data-id="{{ user.id }}" data-username="{{ user.username }}"
                                                onclick="handleChangePassword(this)"
                                                class="w-full flex items-center gap-2 px-4 py-3 text-sm text-indigo-600 hover:bg-indigo-50 transition-colors">
                                                <i class="bi bi-key"></i>
                                                Set Password
                                            </button>
                                            <button data-id="{{ user.id }}" data-username="{{ user.username }}"
                                                onclick="handleDeleteUser(this)"
                                                class="w-full flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                                <i class="bi bi-trash"></i>
                                                Delete User
                                            </button>

                                            <!-- Hidden Forms for Actions -->
                                            <form id="delete-form-{{ user.id }}"
                                                action="{{ url_for('hr3.delete_user', user_id=user.id) }}" method="POST"
                                                class="hidden">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            </form>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Change Password Modal -->
<div id="passwordModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background backdrop -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true"
            onclick="closeChangePasswordModal()"></div>

        <!-- Modal panel -->
        <div
            class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
            <div class="bg-white px-8 pt-8 pb-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600">
                        <i class="bi bi-shield-lock text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900" id="modal-title">Change Password</h3>
                        <p class="text-sm text-gray-500" id="modal-subtitle">Update password for <span
                                id="target-username" class="font-bold text-indigo-600"></span></p>
                    </div>
                </div>

                <form id="changePasswordForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <!-- Password Error Container -->
                    <div id="passwordError" class="hidden mb-4">
                        <div
                            class="p-4 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm flex items-center gap-3">
                            <i class="bi bi-x-circle-fill"></i>
                            <span id="passwordErrorMessage"></span>
                        </div>
                    </div>

                    <!-- Password Success Container -->
                    <div id="passwordSuccess" class="hidden mb-4">
                        <div
                            class="p-4 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm flex items-center gap-3">
                            <i class="bi bi-check-circle-fill"></i>
                            <span id="passwordSuccessMessage"></span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="new_password" class="block text-sm font-bold text-gray-700 mb-2">New Secure
                                Password</label>
                            <div class="relative">
                                <span
                                    class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                                    <i class="bi bi-key"></i>
                                </span>
                                <input type="password" name="new_password" id="modal_new_password" required
                                    class="block w-full pl-11 pr-4 py-3.5 bg-gray-50 border border-gray-200 rounded-2xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                                    placeholder="Enter new password">
                                <button type="button" onclick="toggleModalPassword()"
                                    class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-600">
                                    <i class="bi bi-eye" id="modal-eye-icon"></i>
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Minimum 8 characters with letters and numbers
                                recommended.</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-8 py-6 flex flex-row-reverse gap-3">
                <button type="button" onclick="submitPasswordForm()"
                    class="w-full inline-flex justify-center rounded-2xl border border-transparent shadow-lg py-3 px-6 bg-indigo-600 text-base font-bold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all sm:w-auto">
                    Save Changes
                </button>
                <button type="button" onclick="closeChangePasswordModal()"
                    class="w-full inline-flex justify-center rounded-2xl border border-gray-200 shadow-sm py-3 px-6 bg-white text-base font-bold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all sm:w-auto">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View User Details Modal -->
<div id="viewUserModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-labelledby="view-modal-title"
    role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true"
            onclick="closeViewUserModal()"></div>

        <div
            class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-indigo-600 px-8 py-10 text-white relative">
                <button onclick="closeViewUserModal()"
                    class="absolute top-6 right-6 text-white/80 hover:text-white transition-colors">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
                <div class="flex items-center gap-6">
                    <div id="view-avatar"
                        class="w-20 h-20 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center text-3xl font-bold shadow-inner">
                        A
                    </div>
                    <div>
                        <h3 class="text-3xl font-bold" id="view-username">John Doe</h3>
                        <p class="text-indigo-100 flex items-center gap-2 mt-1">
                            <i class="bi bi-envelope"></i>
                            <span id="view-email">john@example.com</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white px-8 py-8">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Subsystem</p>
                        <p class="text-gray-900 font-bold flex items-center gap-2">
                            <i class="bi bi-cpu text-indigo-500"></i>
                            <span id="view-subsystem">HR3</span>
                        </p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Department</p>
                        <p class="text-gray-900 font-bold flex items-center gap-2">
                            <i class="bi bi-building text-indigo-500"></i>
                            <span id="view-department">Human Resources</span>
                        </p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Role</p>
                        <p class="text-gray-900 font-bold flex items-center gap-2">
                            <i class="bi bi-shield-lock text-indigo-500"></i>
                            <span id="view-role">Administrator</span>
                        </p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Status</p>
                        <p id="view-status-badge"
                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">
                            Active
                        </p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Joined Date</p>
                        <p class="text-gray-900 font-bold flex items-center gap-2">
                            <i class="bi bi-calendar-event text-indigo-500"></i>
                            <span id="view-joined">Jan 10, 2026</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-8 py-6 flex flex-row-reverse">
                <button type="button" onclick="closeViewUserModal()"
                    class="w-full inline-flex justify-center rounded-2xl border border-gray-200 shadow-sm py-3 px-8 bg-white text-base font-bold text-gray-700 hover:bg-gray-50 focus:outline-none transition-all sm:w-auto">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-labelledby="add-modal-title"
    role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true"
            onclick="closeAddUserModal()"></div>

        <div
            class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-[#0EA5E9] px-8 py-8 text-white relative">
                <button onclick="closeAddUserModal()"
                    class="absolute top-6 right-6 text-white/80 hover:text-white transition-colors">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
                <div class="flex items-center gap-4">
                    <div
                        class="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center text-2xl font-bold shadow-inner">
                        <i class="bi bi-person-plus"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold" id="add-modal-title">Add New User</h3>
                        <p class="text-blue-50 text-sm">Create a new system account manually</p>
                    </div>
                </div>
            </div>

            <form id="addUserForm" action="{{ url_for('hr3.add_user') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- Add User Error Container -->
                <div id="addUserError" class="hidden px-8 pt-4">
                    <div
                        class="p-4 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm flex items-center gap-3">
                        <i class="bi bi-x-circle-fill"></i>
                        <span id="addUserErrorMessage"></span>
                    </div>
                </div>

                <!-- Add User Success Container -->
                <div id="addUserSuccess" class="hidden px-8 pt-4">
                    <div
                        class="p-4 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm flex items-center gap-3">
                        <i class="bi bi-check-circle-fill"></i>
                        <span id="addUserSuccessMessage"></span>
                    </div>
                </div>
                <div class="bg-white px-8 py-8 space-y-5">
                    <div class="grid grid-cols-2 gap-5">
                        <div class="col-span-2">
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Username</label>
                            <input type="text" name="username" required minlength="3"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0EA5E9] focus:border-transparent transition-all invalid:border-red-500 invalid:text-red-600 focus:invalid:ring-red-500"
                                placeholder="Enter username" title="Username must be at least 3 characters long">



                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Email
                                Address</label>
                            <input type="email" name="email" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0EA5E9] focus:border-transparent transition-all invalid:border-red-500 invalid:text-red-600 focus:invalid:ring-red-500"
                                placeholder="Enter email address" title="Please enter a valid email address">



                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Initial
                                Password</label>
                            <input type="password" name="password" required
                                pattern="(?=.*[A-Z])(?=.*[0-9])(?=.*[$!@#$%^&amp;*()_+\-=\[\]{}|;:'&quot;,.\/&lt;&gt;?~`]).{8,14}"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0EA5E9] focus:border-transparent transition-all invalid:border-red-500 invalid:text-red-600 focus:invalid:ring-red-500"
                                placeholder="Enter initial password"
                                title="Password must be 8-14 characters and include at least one uppercase letter, one number, and one special character.">



                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Subsystem</label>
                            <select name="subsystem" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0EA5E9] focus:border-transparent transition-all">
                                {% for code, config in subsystem_config.items() %}
                                <option value="{{ code }}">{{ code|upper }} - {{ config.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Role</label>
                            <select name="role" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0EA5E9] focus:border-transparent transition-all">
                                <option value="Staff">Staff</option>
                                <option value="Admin">Admin</option>
                                <option value="Administrator">Administrator</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Account
                                Status</label>
                            <select name="status" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#0EA5E9] focus:border-transparent transition-all">
                                <option value="Active">Active</option>
                                <option value="Pending">Pending</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-8 py-6 flex flex-row-reverse gap-3">
                    <button type="submit"
                        class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-lg py-3 px-8 bg-[#0EA5E9] text-base font-bold text-white hover:bg-[#0284C7] focus:outline-none transition-all sm:w-auto">
                        Create User
                    </button>
                    <button type="button" onclick="closeAddUserModal()"
                        class="w-full inline-flex justify-center rounded-xl border border-gray-200 shadow-sm py-3 px-8 bg-white text-base font-bold text-gray-700 hover:bg-gray-50 focus:outline-none transition-all sm:w-auto">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-labelledby="edit-modal-title"
    role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true"
            onclick="closeEditUserModal()"></div>

        <div
            class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-amber-500 px-8 py-8 text-white relative">
                <button onclick="closeEditUserModal()"
                    class="absolute top-6 right-6 text-white/80 hover:text-white transition-colors">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
                <div class="flex items-center gap-4">
                    <div
                        class="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center text-2xl font-bold shadow-inner">
                        <i class="bi bi-pencil-square"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold" id="edit-modal-title">Edit User Details</h3>
                        <p class="text-amber-50 text-sm">Update profile information for <span id="edit-target-username"
                                class="font-bold"></span></p>
                    </div>
                </div>
            </div>

            <form id="editUserForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- Edit User Error Container -->
                <div id="editUserError" class="hidden px-8 pt-4">
                    <div
                        class="p-4 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm flex items-center gap-3">
                        <i class="bi bi-x-circle-fill"></i>
                        <span id="editUserErrorMessage"></span>
                    </div>
                </div>

                <!-- Edit User Success Container -->
                <div id="editUserSuccess" class="hidden px-8 pt-4">
                    <div
                        class="p-4 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm flex items-center gap-3">
                        <i class="bi bi-check-circle-fill"></i>
                        <span id="editUserSuccessMessage"></span>
                    </div>
                </div>
                <div class="bg-white px-8 py-8 space-y-5">
                    <div class="grid grid-cols-2 gap-5">
                        <div class="col-span-2">
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Username</label>
                            <input type="text" name="username" id="edit_username" required minlength="3"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all invalid:border-red-500 invalid:text-red-600 focus:invalid:ring-red-500"
                                title="Username must be at least 3 characters long">


                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Email
                                Address</label>
                            <input type="email" name="email" id="edit_email" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all invalid:border-red-500 invalid:text-red-600 focus:invalid:ring-red-500"
                                title="Please enter a valid email address">


                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Subsystem</label>
                            <select name="subsystem" id="edit_subsystem" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all">
                                {% for code, config in subsystem_config.items() %}
                                <option value="{{ code }}">{{ code|upper }} - {{ config.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Role</label>
                            <select name="role" id="edit_role" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all">
                                <option value="Staff">Staff</option>
                                <option value="Admin">Admin</option>
                                <option value="Administrator">Administrator</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Account
                                Status</label>
                            <select name="status" id="edit_status" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all">
                                <option value="Pending">Pending</option>
                                <option value="Active">Active</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-8 py-6 flex flex-row-reverse gap-3">
                    <button type="submit"
                        class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-lg py-3 px-8 bg-amber-500 text-base font-bold text-white hover:bg-amber-600 focus:outline-none transition-all sm:w-auto">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditUserModal()"
                        class="w-full inline-flex justify-center rounded-xl border border-gray-200 shadow-sm py-3 px-8 bg-white text-base font-bold text-gray-700 hover:bg-gray-50 focus:outline-none transition-all sm:w-auto">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Action handlers using data attributes
    function handleViewDetails(btn) {
        const d = btn.dataset;
        viewUserDetails(d.id, d.username, d.email, d.subsystem, d.department, d.role, d.status, d.joined);
    }

    function handleEditUser(btn) {
        const d = btn.dataset;
        openEditUserModal(d.id, d.username, d.email, d.subsystem, d.role, d.status);
    }

    function handleChangePassword(btn) {
        const d = btn.dataset;
        openChangePasswordModal(d.id, d.username);
    }

    function handleDeleteUser(btn) {
        const d = btn.dataset;
        deleteUser(d.id, d.username);
    }

    // Toggle dropdown menu
    function toggleDropdown(button) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu !== button.nextElementSibling) {
                menu.classList.add('hidden');
            }
        });

        const menu = button.nextElementSibling;
        if (menu) menu.classList.toggle('hidden');
    }

    // Action functions
    function deleteUser(userId, username) {
        if (confirm(`Are you sure you want to PERMANENTLY delete user "${username}"? This action cannot be undone.`)) {
            document.getElementById(`delete-form-${userId}`).submit();
        }
    }

    const addUserModal = document.getElementById('addUserModal');
    const passwordModal = document.getElementById('passwordModal');
    const viewUserModal = document.getElementById('viewUserModal');
    const editUserModal = document.getElementById('editUserModal');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const editUserForm = document.getElementById('editUserForm');
    const targetUsernameSpan = document.getElementById('target-username');
    const modalNewPasswordInput = document.getElementById('modal_new_password');

    function openAddUserModal() {
        document.getElementById('addUserError').classList.add('hidden');
        document.getElementById('addUserSuccess').classList.add('hidden');
        document.getElementById('addUserForm').reset();
        addUserModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeAddUserModal() {
        addUserModal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Generic AJAX Form Handler
    async function handleFormSubmit(form, errorContainerId, errorMessageId, successContainerId, successMessageId) {
        const errorContainer = document.getElementById(errorContainerId);
        const errorMessage = document.getElementById(errorMessageId);

        const successContainer = successContainerId ? document.getElementById(successContainerId) : null;
        const successMessage = successMessageId ? document.getElementById(successMessageId) : null;

        errorContainer.classList.add('hidden');
        if (successContainer) successContainer.classList.add('hidden');

        const formData = new FormData(form);
        try {
            const response = await fetch(form.action || window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const result = await response.json();

            if (response.ok) {
                // Success - reload to show flash message and updated data
                // Success - show notice then reload
                if (successContainer && successMessage) {
                    successMessage.textContent = result.message || 'Action completed successfully.';
                    successContainer.classList.remove('hidden');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    window.location.reload();
                }
            } else {
                // Error - show in modal
                errorMessage.textContent = result.message || 'An error occurred. Please try again.';
                errorContainer.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error:', error);
            errorMessage.textContent = 'A network error occurred. Please try again.';
            errorContainer.classList.remove('hidden');
        }
    }
    // Attach AJAX handlers
    document.addEventListener('DOMContentLoaded', function () {
        const addUserForm = document.getElementById('addUserForm');
        if (addUserForm) {
            addUserForm.addEventListener('submit', function (e) {
                e.preventDefault();
                handleFormSubmit(this, 'addUserError', 'addUserErrorMessage', 'addUserSuccess', 'addUserSuccessMessage');
            });
        }

        const editUserForm = document.getElementById('editUserForm');
        if (editUserForm) {
            editUserForm.addEventListener('submit', function (e) {
                e.preventDefault();
                handleFormSubmit(this, 'editUserError', 'editUserErrorMessage', 'editUserSuccess', 'editUserSuccessMessage');
            });
        }
    });



    function openEditUserModal(id, username, email, subsystem, role, status) {
        document.getElementById('editUserError').classList.add('hidden');
        document.getElementById('editUserSuccess').classList.add('hidden');
        document.getElementById('edit-target-username').textContent = username;
        document.getElementById('edit_username').value = username;
        document.getElementById('edit_email').value = email;
        document.getElementById('edit_subsystem').value = subsystem.toLowerCase();
        document.getElementById('edit_role').value = role;
        document.getElementById('edit_status').value = status;

        editUserForm.action = `/hr/hr3/admin/users/${id}/edit`;
        editUserModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeEditUserModal() {
        editUserModal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    function viewUserDetails(id, username, email, subsystem, department, role, status, joined) {
        document.getElementById('view-username').textContent = username;
        document.getElementById('view-email').textContent = email;
        document.getElementById('view-subsystem').textContent = subsystem;
        document.getElementById('view-department').textContent = department;
        document.getElementById('view-role').textContent = role;
        document.getElementById('view-joined').textContent = joined;
        document.getElementById('view-avatar').textContent = username.charAt(0).toUpperCase();

        const statusBadge = document.getElementById('view-status-badge');
        statusBadge.textContent = status;

        // Status styling
        statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider';
        if (status === 'Active') {
            statusBadge.classList.add('bg-emerald-50', 'text-emerald-600', 'border', 'border-emerald-100');
        } else if (status === 'Pending') {
            statusBadge.classList.add('bg-amber-50', 'text-amber-600', 'border', 'border-amber-100');
        } else {
            statusBadge.classList.add('bg-red-50', 'text-red-600', 'border', 'border-red-100');
        }

        viewUserModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeViewUserModal() {
        viewUserModal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    function openChangePasswordModal(userId, username) {
        document.getElementById('passwordError').classList.add('hidden');
        document.getElementById('passwordSuccess').classList.add('hidden');
        targetUsernameSpan.textContent = username;
        changePasswordForm.action = `/hr/hr3/admin/users/${userId}/change-password`;
        passwordModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    function closeChangePasswordModal() {
        passwordModal.classList.add('hidden');
        document.body.style.overflow = '';
        modalNewPasswordInput.value = '';
    }

    function submitPasswordForm() {
        const errorContainer = document.getElementById('passwordError');
        const errorMessage = document.getElementById('passwordErrorMessage');

        if (modalNewPasswordInput.value.length < 8) {
            errorMessage.textContent = 'Password must be at least 8 characters long.';
            errorContainer.classList.remove('hidden');
            return;
        }
        handleFormSubmit(changePasswordForm, 'passwordError', 'passwordErrorMessage', 'passwordSuccess', 'passwordSuccessMessage');
    }







    function toggleModalPassword() {
        const icon = document.getElementById('modal-eye-icon');
        if (modalNewPasswordInput.type === 'password') {
            modalNewPasswordInput.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            modalNewPasswordInput.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.relative')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeAddUserModal();
            closeChangePasswordModal();
            closeViewUserModal();
            closeEditUserModal();
        }
    });

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            // Update active state
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-[#0EA5E9]', 'text-white', 'shadow-md', 'active');
                b.classList.add('bg-white', 'text-gray-600', 'border', 'border-gray-200');
            });
            this.classList.remove('bg-white', 'text-gray-600', 'border', 'border-gray-200');
            this.classList.add('bg-[#0EA5E9]', 'text-white', 'shadow-md', 'active');

            // Filter rows
            const filter = this.dataset.filter;
            document.querySelectorAll('.user-row').forEach(row => {
                if (filter === 'all' || row.dataset.status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}
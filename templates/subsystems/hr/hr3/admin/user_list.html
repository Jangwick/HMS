{% extends "base/base.html" %}

{% block title %}User Directory - {{ subsystem_name }}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 overflow-hidden font-sans">
    <!-- Sidebar -->
    <aside class="w-72 bg-white shadow-2xl hidden md:flex flex-col z-20 border-r border-gray-100">
        <div class="h-20 flex items-center px-8 border-b border-gray-100">
            <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#0EA5E9] to-gray-800 flex items-center justify-center shadow-lg mr-4 text-white">
                <i class="bi bi-clock-history text-lg"></i>
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-gray-900 tracking-tight">HR3</h1>
                <p class="text-xs font-medium text-gray-400 uppercase tracking-wider">System</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Main Menu</p>

            <a href="{{ url_for('hr3.dashboard') }}"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i
                    class="bi bi-speedometer2 text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Dashboard
            </a>

            <a href="#"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i class="bi bi-people text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Personnel
            </a>

            <a href="#"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i
                    class="bi bi-file-earmark-text text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Reports
            </a>

            {% if current_user.role in ['Admin', 'Administrator'] and current_user.subsystem == 'hr3' %}
            <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">Administration</p>

            <a href="{{ url_for('hr3.pending_approvals') }}"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i
                    class="bi bi-person-check text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Pending Approvals
            </a>

            <a href="{{ url_for('hr3.user_list') }}"
                class="flex items-center px-4 py-3 bg-[#0EA5E9]/10 text-[#0EA5E9] rounded-xl transition-all duration-200 font-bold group shadow-sm">
                <i class="bi bi-people-fill text-xl mr-3 group-hover:scale-110 transition-transform"></i>
                User Directory
            </a>
            {% endif %}

            <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">System</p>

            <a href="#"
                class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all duration-200 font-medium group">
                <i class="bi bi-gear text-xl mr-3 text-gray-400 group-hover:text-[#0EA5E9] transition-colors"></i>
                Settings
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50/50">
            <div class="flex items-center mb-4 p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-white font-bold shadow-md">
                    {{ current_user.username[0] | upper }}
                </div>
                <div class="ml-3 overflow-hidden">
                    <p class="text-sm font-bold text-gray-900 truncate">{{ current_user.username }}</p>
                    <p class="text-xs text-gray-500 truncate">{{ current_user.role }}</p>
                </div>
            </div>
            <a href="{{ url_for('hr3.logout') }}"
                class="flex items-center justify-center w-full px-4 py-2.5 text-sm font-bold text-red-600 bg-red-50 rounded-xl hover:bg-red-100 transition-all duration-200 hover:shadow-md">
                <i class="bi bi-box-arrow-right mr-2"></i> Sign Out
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Top Header -->
        <header
            class="bg-white/80 backdrop-blur-md shadow-sm h-20 flex items-center justify-between px-8 sticky top-0 z-10 border-b border-gray-100">
            <div class="flex items-center">
                <h2 class="text-2xl font-bold text-gray-800 tracking-tight">User Directory</h2>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-6 space-y-3">
            {% for category, message in messages %}
            <div class="p-4 rounded-xl flex items-center gap-3
                    {% if category == 'success' %}bg-emerald-50 border border-emerald-200 text-emerald-700
                    {% elif category == 'danger' %}bg-red-50 border border-red-200 text-red-700
                    {% elif category == 'warning' %}bg-amber-50 border border-amber-200 text-amber-700
                    {% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %}">
                {% if category == 'success' %}
                <i class="bi bi-check-circle-fill"></i>
                {% elif category == 'danger' %}
                <i class="bi bi-x-circle-fill"></i>
                {% elif category == 'warning' %}
                <i class="bi bi-exclamation-triangle-fill"></i>
                {% else %}
                <i class="bi bi-info-circle-fill"></i>
                {% endif %}
                <span class="font-medium">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Filter Tabs -->
        <div class="flex gap-2 mb-6 flex-wrap">
            <button
                class="filter-btn active px-4 py-2 rounded-xl text-sm font-medium transition-all bg-[#0EA5E9] text-white shadow-md"
                data-filter="all">
                All Users ({{ users|length }})
            </button>
            <button
                class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"
                data-filter="Active">
                Active ({{ users|selectattr('status', 'equalto', 'Active')|list|length }})
            </button>
            <button
                class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"
                data-filter="Pending">
                Pending ({{ users|selectattr('status', 'equalto', 'Pending')|list|length }})
            </button>
            <button
                class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"
                data-filter="Rejected">
                Rejected ({{ users|selectattr('status', 'equalto', 'Rejected')|list|length }})
            </button>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-100">
                            <th class="px-6 py-4 text-sm font-bold text-gray-600">User</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-600">Department</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-600">Role</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-600">Status</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-600">Password</th>
                            <th class="px-6 py-4 text-sm font-bold text-gray-600 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for user in users %}
                        <tr class="user-row hover:bg-gray-50 transition-colors" data-status="{{ user.status }}">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-gradient-to-br from-[#0EA5E9] to-gray-600 flex items-center justify-center text-white font-bold shadow-md">
                                        {{ user.username[0]|upper }}
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">{{ user.username }}</div>
                                        <div class="text-xs text-gray-500">{{ user.email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 rounded-md bg-gray-100 text-xs font-medium text-gray-600">
                                    {{ user.subsystem|upper }}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-sm text-gray-700">{{ user.role }}</span>
                            </td>
                            <td class="px-6 py-4">
                                {% if user.status == 'Active' %}
                                <span
                                    class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-600 text-[10px] font-bold uppercase tracking-wider border border-emerald-100">Active</span>
                                {% elif user.status == 'Pending' %}
                                <span
                                    class="px-3 py-1 rounded-full bg-amber-50 text-amber-600 text-[10px] font-bold uppercase tracking-wider border border-amber-100">Pending</span>
                                {% else %}
                                <span
                                    class="px-3 py-1 rounded-full bg-red-50 text-red-600 text-[10px] font-bold uppercase tracking-wider border border-red-100">{{
                                    user.status }}</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if user.is_password_expired() %}
                                <span class="flex items-center gap-1 text-red-500 text-xs font-medium">
                                    <i class="bi bi-exclamation-circle-fill"></i>
                                    Expired
                                </span>
                                {% else %}
                                <span class="text-gray-500 text-xs">{{ user.days_until_password_expiry() }}d
                                    left</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="relative inline-block text-left">
                                    <button onclick="toggleDropdown(this)"
                                        class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <div
                                        class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-xl shadow-xl z-50 overflow-hidden">
                                        {% if user.status == 'Pending' %}
                                        <a href="{{ url_for('hr3.process_approval', user_id=user.id, action='approve') }}"
                                            class="flex items-center gap-2 px-4 py-3 text-sm text-emerald-600 hover:bg-emerald-50 transition-colors">
                                            <i class="bi bi-check-lg"></i>
                                            Approve User
                                        </a>
                                        <a href="{{ url_for('hr3.process_approval', user_id=user.id, action='deny') }}"
                                            class="flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                            <i class="bi bi-x-lg"></i>
                                            Deny User
                                        </a>
                                        {% elif user.status == 'Active' %}
                                        <a href="{{ url_for('hr3.reset_user_password', user_id=user.id) }}" 
                                           class="flex items-center gap-2 px-4 py-3 text-sm text-gray-600 hover:bg-gray-50 transition-colors"
                                           onclick="return confirm('Are you sure you want to reset this user\'s password to default?')">
                                            <i class="bi bi-shield-lock"></i>
                                            Reset Password
                                        </a>
                                        <a href="{{ url_for('hr3.toggle_user_status', user_id=user.id) }}" 
                                           class="flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors"
                                           onclick="return confirm('Are you sure you want to deactivate this user?')">
                                            <i class="bi bi-person-x"></i>
                                            Deactivate User
                                        </a>
                                        {% else %}
                                        <a href="{{ url_for('hr3.toggle_user_status', user_id=user.id) }}" 
                                           class="flex items-center gap-2 px-4 py-3 text-sm text-emerald-600 hover:bg-emerald-50 transition-colors">
                                            <i class="bi bi-person-check"></i>
                                            Activate User
                                        </a>
                                        {% endif %}
                                        
                                        <!-- Global Actions (All states) -->
                                        <hr class="border-gray-100">
                                        <button onclick="openChangePasswordModal('{{ user.id }}', '{{ user.username }}')"
                                            class="w-full flex items-center gap-2 px-4 py-3 text-sm text-indigo-600 hover:bg-indigo-50 transition-colors">
                                            <i class="bi bi-key"></i>
                                            Set Password
                                        </button>
                                        <button onclick="deleteUser('{{ user.id }}', '{{ user.username }}')"
                                            class="w-full flex items-center gap-2 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                            <i class="bi bi-trash"></i>
                                            Delete User
                                        </button>

                                        <!-- Hidden Forms for Actions -->
                                        <form id="delete-form-{{ user.id }}" action="{{ url_for('hr3.delete_user', user_id=user.id) }}" method="POST" class="hidden">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        </form>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        </main>
    </div>
</div>

<!-- Change Password Modal -->
<div id="passwordModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background backdrop -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true" onclick="closeChangePasswordModal()"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white rounded-3xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
            <div class="bg-white px-8 pt-8 pb-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600">
                        <i class="bi bi-shield-lock text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900" id="modal-title">Change Password</h3>
                        <p class="text-sm text-gray-500" id="modal-subtitle">Update password for <span id="target-username" class="font-bold text-indigo-600"></span></p>
                    </div>
                </div>

                <form id="changePasswordForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="space-y-4">
                        <div>
                            <label for="new_password" class="block text-sm font-bold text-gray-700 mb-2">New Secure Password</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                                    <i class="bi bi-key"></i>
                                </span>
                                <input type="password" name="new_password" id="modal_new_password" required
                                    class="block w-full pl-11 pr-4 py-3.5 bg-gray-50 border border-gray-200 rounded-2xl text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                                    placeholder="Enter new password">
                                <button type="button" onclick="toggleModalPassword()" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-indigo-600">
                                    <i class="bi bi-eye" id="modal-eye-icon"></i>
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Minimum 8 characters with letters and numbers recommended.</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-8 py-6 flex flex-row-reverse gap-3">
                <button type="button" onclick="submitPasswordForm()"
                    class="w-full inline-flex justify-center rounded-2xl border border-transparent shadow-lg py-3 px-6 bg-indigo-600 text-base font-bold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all sm:w-auto">
                    Save Changes
                </button>
                <button type="button" onclick="closeChangePasswordModal()"
                    class="w-full inline-flex justify-center rounded-2xl border border-gray-200 shadow-sm py-3 px-6 bg-white text-base font-bold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all sm:w-auto">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle dropdown menu
    function toggleDropdown(button) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu !== button.nextElementSibling) {
                menu.classList.add('hidden');
            }
        });

        const menu = button.nextElementSibling;
        if (menu) menu.classList.toggle('hidden');
    }

    // Action functions
    function deleteUser(userId, username) {
        if (confirm(`Are you sure you want to PERMANENTLY delete user "${username}"? This action cannot be undone.`)) {
            document.getElementById(`delete-form-${userId}`).submit();
        }
    }

    const passwordModal = document.getElementById('passwordModal');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const targetUsernameSpan = document.getElementById('target-username');
    const modalNewPasswordInput = document.getElementById('modal_new_password');

    function openChangePasswordModal(userId, username) {
        targetUsernameSpan.textContent = username;
        changePasswordForm.action = `/hr/hr3/admin/users/${userId}/change-password`;
        passwordModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    function closeChangePasswordModal() {
        passwordModal.classList.add('hidden');
        document.body.style.overflow = '';
        modalNewPasswordInput.value = '';
    }

    function submitPasswordForm() {
        if (modalNewPasswordInput.value.length < 8) {
            alert('Password must be at least 8 characters long.');
            return;
        }
        changePasswordForm.submit();
    }

    function toggleModalPassword() {
        const icon = document.getElementById('modal-eye-icon');
        if (modalNewPasswordInput.type === 'password') {
            modalNewPasswordInput.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            modalNewPasswordInput.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.relative')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeChangePasswordModal();
        }
    });

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            // Update active state
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-[#0EA5E9]', 'text-white', 'shadow-md', 'active');
                b.classList.add('bg-white', 'text-gray-600', 'border', 'border-gray-200');
            });
            this.classList.remove('bg-white', 'text-gray-600', 'border', 'border-gray-200');
            this.classList.add('bg-[#0EA5E9]', 'text-white', 'shadow-md', 'active');

            // Filter rows
            const filter = this.dataset.filter;
            document.querySelectorAll('.user-row').forEach(row => {
                if (filter === 'all' || row.dataset.status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}